### Шардирование таблиц
[Подробно](https://docs.citusdata.com/en/v12.0/performance/performance_tuning.html#table-distribution-and-shards)

В качестве поля для шардирования выбираем то что либо
* участвует в объединениях
* используется в фильтрах

Это позволяет исключить неиспользуемые шарды. 
Кроме того, Citus делегитрует вычисления на рабочие узлы, распределяя нагрузку и сокращая сетевой трафик.

### Оптимизация рабочих узлов
[Подробно](https://docs.citusdata.com/en/v12.0/performance/performance_tuning.html#postgresql-tuning)

Узлы представляют собой ничто иное как просто экземпляры PG. Координатор распределяет запросы для параллельного прцессинга по узлам, а узлы в свою очередь просто работают в качестве отдельного экземпляра.
Сооотв к ним относится все что касается оптимизации PG.

#### Техника оптимизации
Пускаем запрос на основном узле
```
EXPLAIN VERBOSE
 SELECT...
```
Собираем план. в котором будет присутствовать контекстный запрос со всеми контекстными объектами узла.
Далее идем с этим запросом на узел и оптимизируем его. Далее пропагандируем оптимизацию на все узлы.

Чтобы увидеть всю картину по всем узлам, ставим флаг
```
SET citus.explain_all_tasks = 1;
```
После чего получаем разворотку EXPLAIN по всем узлам.
реальное положение узнаем при помощи EXPLAIN ANALYZE, которая сортирует планы по убыванию времени выполнения. а без разворотки (citus.explain_all_tasks = 0) показывает самый длительный план.

> Разница в выполнении может быть из-за железа, конфигурации или локальных перекосов данных.


