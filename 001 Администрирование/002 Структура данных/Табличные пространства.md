[Презентация](https://www.youtube.com/watch?v=uPfM74fKm9o&list=PLaFqU3KCWw6LPcuYVymLcXl3muC45mu3e&index=11)
[Материалы](https://edu.postgrespro.ru/dba1-13/dba1_11_data_lowlevel.html)
## Общее
Табличные пространства - способ физической организации данных. Каталог, находящейся где-либо на файловой системе.
#### Табличное пространство pg_global
Общее пространство для всего кластера. Там находятся объекты системного каталога, видимые всем базам кластера.
> PGDATA/global/

#### Табличное пространство pg_default
Аналог PRIMARY.
> PGDATA/base/

#### Пользовательское табличное пространство
На самом деле можно также создать свое табличное пространство и назначить его по умолчанию.
При создании пользовательского табличного пространства, создается символическаля ссылка в каталоге
> PGDATA/table_space/tsoid -> /table_space_path/ver/dboid/

#### Мониторинг
```
-- Список
select * from pg_tablespace
-- Размер таблички
select pg_size_pretty(pg_table_size('table'));
-- Список в psql
\db
```
#### Создание табличного пространства
```
sudo mkdir /path..
sudo chown postgres /path..
-- psql
CREATE TABLESPACE ts LOCATION /path..
\db
\db+
```
> Одно табличное пространство может использоваться несколькими базами данных.

#### Создание базы с табличным пространством по умолчанию
```
CREATE DATABASE db TABLSPACE ts;
```
#### Переназначение базе табличного пространства по умолчанию
> Все объекти системного каталога переедут в новое табличное пространство

```
ALTER DATABASE db SET TABLESPACE pg_default;
```
#### Создание объекта в пользовательском табличном пространстве 
```
CREATE TABLE t1 () TABLESPACE ts;
select tablemname, tablespace from pg_tables; -- tablespace пусто = tablespace по умолчанию
```
#### Смена табличного пространства
В отличие от схемы, смена табличного пространства ведет к физической смене местоположения файлов (копирование).
```
ALTER TABLE t SET TABLSPACE table_space;
ALTER TABLE ALL IN TABLESPACE ts_1 SET TABLSPACE ts_2;
```
#### Удаление табличного пространства
Удалить каскадом, в отличие от схемы, нельзя. Там могут объекты разных баз.
```
-- Идентификатор пространства
select oid from pg_tablespace where spcname = 'ts';
-- Имена баз
select datname
from pg_database
where oid in (select pg_tablespace_databases(select oid from pg_tablespace where spcname = 'ts'))
-- Переключаемся в каждую базу и ищем объекты
select relnamespace::regnamespace, * from pg_class where reltablespace = (select oid from pg_tablespace where spcname = 'ts')
-- Чистим
DROP TABLE
-- Перемещаем системный каталог
ALTER DATABASE db SET TABLESPACE pg_default;
-- По завершении удаляем пустое пользовательское пространство
DROP TABLESPACE ts;
```
## Низкоуровневое представление
Каждый файл состоит из трех слоев (fork) - main (основный данные), init(заглушка, только для нежурналируемых таблиц) fsm (карта свободного пространства), vm (карта видимости).
Каждый слой состоит из 1Гб сегментов. При достижении размера в 1ГБ файл (N) финализируется и создается следующий  и т.д. (N.1, N.2, ...N.N).
> Размер сегмента можно поменять при компиляции.

```
pg_relation_size -- показывает общий размер слоя (все сегменты)
```
[Путь до файла объекта](https://github.com/AV-ghub/PostgreSQL/blob/main/001%20%D0%90%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/010%20%D0%97%D0%B0%D0%B4%D0%B0%D1%87%D0%B8%20%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F/%D0%9F%D0%BE%D0%BB%D0%B5%D0%B7%D0%BD%D1%8B%D0%B5%20%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D1%8B.md#%D0%BF%D1%83%D1%82%D1%8C-%D0%B4%D0%BE-%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D0%BE%D0%B3%D0%BE-%D1%84%D0%B0%D0%B9%D0%BB%D0%B0-%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D1%8B-%D0%BE%D1%82%D0%BD%D0%BE%D1%81%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE-pgdata)

Индекс файла также можно посмотреть
```
\d t
select pg_relation_filepath('t_pkey');
```
У индекса не бывает vm (не хранит версии строк), но бывает fsm.

[Получить объекты по имени файла](https://github.com/AV-ghub/PostgreSQL/blob/main/001%20%D0%90%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/010%20%D0%97%D0%B0%D0%B4%D0%B0%D1%87%D0%B8%20%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F/%D0%9F%D0%BE%D0%BB%D0%B5%D0%B7%D0%BD%D1%8B%D0%B5%20%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D1%8B.md#%D0%BF%D0%BE%D0%BB%D1%83%D1%87%D0%B8%D1%82%D1%8C-%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D1%8B-%D0%BF%D0%BE-%D0%B8%D0%BC%D0%B5%D0%BD%D0%B8-%D1%84%D0%B0%D0%B9%D0%BB%D0%B0)

[Получить размер конкретных слоев](https://github.com/AV-ghub/PostgreSQL/blob/main/001%20%D0%90%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/010%20%D0%97%D0%B0%D0%B4%D0%B0%D1%87%D0%B8%20%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F/%D0%9F%D0%BE%D0%BB%D0%B5%D0%B7%D0%BD%D1%8B%D0%B5%20%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D1%8B.md#%D0%BF%D0%BE%D0%BB%D1%83%D1%87%D0%B8%D1%82%D1%8C-%D1%80%D0%B0%D0%B7%D0%BC%D0%B5%D1%80-%D0%BA%D0%BE%D0%BD%D0%BA%D1%80%D0%B5%D1%82%D0%BD%D1%8B%D1%85-%D1%81%D0%BB%D0%BE%D0%B5%D0%B2)

[Размер таблицы](https://github.com/AV-ghub/PostgreSQL/blob/main/001%20%D0%90%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/010%20%D0%97%D0%B0%D0%B4%D0%B0%D1%87%D0%B8%20%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F/%D0%9F%D0%BE%D0%BB%D0%B5%D0%B7%D0%BD%D1%8B%D0%B5%20%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D1%8B.md#%D1%80%D0%B0%D0%B7%D0%BC%D0%B5%D1%80-%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D1%8B)

#### TOAST
Бинарные данные хранятся также за пределами строки в отдельной структуре, нарезанной на чанки.
Хранится все это в схеме **pg_toast**. Временные - в **pg_toast_temp_N**.

Есть несколько стратегий по работе с выносимыми данными.
Посмотреть текущее состояние колонок можно через
```
\d+ tablename
```
в столбце Storage.

##### Стратегии

* plane - toast не применяется
* extended - применяется сжатие и вынос
* external - сжатие при выносе не используется
* main - обработка происходит в последнюю очередь

Т.е. если мы хотим оставить поля в строке, то необходимо пометить их стратегией main.

##### Изменение стратегии
```
ALTER TABLE t ALTER COLUMN c SET STORAGE EXTERNAL;
```









