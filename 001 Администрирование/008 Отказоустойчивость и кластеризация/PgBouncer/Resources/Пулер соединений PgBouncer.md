[src](https://docs.selectel.ru/cloud/managed-databases/postgresql/connection-pooler/)

## Пулер соединений PgBouncer
В PostgreSQL для обработки каждого соединения клиента создается отдельный процесс. Чем больше число соединений, тем больше процессов, которые используют оперативную память.    
Максимальное число соединений с процессом PostgreSQL определяется параметром **max_connections**.

Количество соединений между пулером и базой данных на каждой из нод кластера определяется размером пула **pool_size**.

> В кластерах облачных баз данных PostgreSQL используется пулер соединений PgBouncer. 

## Максимальное число соединений с процессом PostgreSQL (max_connections)⁠
По умолчанию установлено значение 100 соединений.   
Изменение значения max_connections влечет за собой перезагрузку нод кластера PostgreSQL.

## Размер пула (pool_size)⁠
Максимальное число соединений между пулером соединений и каждой базой данных PostgreSQL на каждой из нод кластера.

Можно выбрать при создании кластера и изменить размер в созданном кластере. Доступные значения — **от 1 до 500**.

## Режим пулинга
Режим пулинга можно выбрать при создании кластера и изменить режим в созданном кластере.

### Режим транзакции (transaction)⁠
Соединение с PostgreSQL поддерживается до тех пор, пока не завершится транзакция. 

***Общее количество клиентских подключений к PgBouncer может достигать 10 000***, но количество активных транзакций определяет размер пула. Например, если размер пула равен 30, то активных транзакций будет 30.

Количество соединений между пулером соединений и каждой базой данных PostgreSQL на каждой из нод кластера также определяется размером пула.

Клиент может одновременно выполнять несколько транзакций на разных соединениях. При этом каждое соединение между пулером соединений и сервером PostgreSQL в течение своего жизненного цикла может выполнять транзакции разных клиентов.

> Режим транзакции снижает нагрузку на ресурсы СУБД, если есть большое количество клиентских подключений с низкой нагрузкой.

#### В режиме transaction не работают:

* команды SET/RESET и LISTEN/NOTIFY;
* WITH HOLD CURSOR;
* PRESERVE/DELETE ROWS во временных таблицах;
* подготовленные операторы (prepared statements): protocol-level prepared plans, PREPARE, DEALLOCATE;
* оператор LOAD;
* рекомендательные блокировки Session-level advisory locks.

### Режим сессии (session)⁠
Cоединение между пулером соединений и сервером PostgreSQL будет поддерживаться до отключения клиента от базы данных.

Количество подключений между пулером соединений и сервером PostgreSQL определяется размером пула. На каждое подключение клиента используется подключение между пулером и сервером PostgreSQL. Соединение возвращается в пул и может быть повторно использовано только после отключения предыдущего клиента от базы данных.

При использовании этого режима нагрузка на ресурсы не снижается.

Этот режим соединений ***полезен для клиентов, у которых много короткоживущих подключений к базе данных***, потому что в таком режиме увеличивается скорость подключения к СУБД.

### Режим оператора (statement)⁠
Пулер вернет соединение в пул, как только будет обработан первый запрос — транзакции с несколькими операторами прервутся, пулер вернет ошибку.

Режим подойдет, если известно, что ***каждая транзакция ограничена только одним запросом (включен AUTOCOMMIT)***.










