## üîß –í–ª–∏—è–Ω–∏–µ `wal_level = logical` –Ω–∞ –≤–µ—Å—å –∫–ª–∞—Å—Ç–µ—Ä

**–ì–ª–∞–≤–Ω–æ–µ: `wal_level = logical` –≤–ª–∏—è–µ—Ç –Ω–∞ –í–ï–°–¨ –∫–ª–∞—Å—Ç–µ—Ä**, –∞ –Ω–µ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –±–∞–∑—ã. –≠—Ç–æ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä, –∫–æ—Ç–æ—Ä—ã–π –º–µ–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø–∏—Å–∏ WAL –¥–ª—è –≤—Å–µ—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ PostgreSQL.

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏:
- **WAL-—Ñ–∞–π–ª—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –∫—Ä—É–ø–Ω–µ–µ** - –ª–æ–≥–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ WAL (–∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ç—Ä–æ–∫, –∞ –Ω–µ –±–ª–æ–∫–æ–≤)
- **–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –¥–∏—Å–∫ I/O** - –±–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –ø–∏—à–µ—Ç—Å—è –≤ WAL
- **–í–æ–∑—Ä–∞—Å—Ç–∞–µ—Ç –æ–±—ä–µ–º —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞** (–µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è)

### –†–∏—Å–∫–∏ "–ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è":
```sql
-- –†–∏—Å–∫ ‚Ññ1: –ë—ã—Å—Ç—Ä—ã–π —Ä–æ—Å—Ç WAL-—Ñ–∞–π–ª–æ–≤
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–º–µ—Ä WAL
SELECT pg_size_pretty(pg_current_wal_lsn() - '0/0'::pg_lsn);
-- –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û: –¥–∞–µ—Ç –æ–≥—Ä–æ–º–Ω—ã–µ —á–∏—Å–ª–∞
pg_size_pretty(pg_wal_lsn_diff(restart_lsn, '0/0')) as retained_wal
-- –ü–†–ê–í–ò–õ–¨–ù–û: —Ç–µ–∫—É—â–µ–µ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ
pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) as lag_size

-- –∏—Ç–æ–≥–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
SELECT 
    slot_name,
    database,
    pg_size_pretty(
        pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)
    ) as lag_size
FROM pg_replication_slots;

-- –†–∏—Å–∫ ‚Ññ2: –ù–µ—Ö–≤–∞—Ç–∫–∞ –º–µ—Å—Ç–∞ –≤ pg_wal
-- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ
SELECT pg_size_pretty(pg_total_relation_size('pg_wal')) as total_wal_size;
```

### –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–ª–æ—Ç–∞:
```sql
SELECT 
    slot_name,
    -- –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è WAL –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ
    pg_current_wal_lsn() as current_wal_lsn,
    -- –° –∫–∞–∫–æ–π –ø–æ–∑–∏—Ü–∏–∏ —Å–ª–æ—Ç –º–æ–∂–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
    restart_lsn,
    -- –î–æ –∫–∞–∫–æ–π –ø–æ–∑–∏—Ü–∏–∏ —Å–ª–æ—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–ª—É—á–µ–Ω–∏–µ
    confirmed_flush_lsn,
    -- –û–¢–°–¢–ê–í–ê–ù–ò–ï: –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–ª–æ—Ç –æ—Ç—Å—Ç–∞–ª –æ—Ç —Ç–µ–∫—É—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) as lag_behind_current,
    -- –ü–†–û–ì–†–ï–°–°: —Å–∫–æ–ª—å–∫–æ —Å–ª–æ—Ç —É–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –æ—Ç —Å–≤–æ–µ–π restart –ø–æ–∑–∏—Ü–∏–∏
    pg_size_pretty(pg_wal_lsn_diff(confirmed_flush_lsn, restart_lsn)) as progress_from_restart
FROM pg_replication_slots 
WHERE slot_name = 'flink_cdc_demo_slot';
```

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å LSN
–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å LSN –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∏–º—è WAL-—Ñ–∞–π–ª–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ PostgreSQL:
```
pg_walfile_name(lsn) ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç LSN –≤ –∏–º—è WAL-—Ñ–∞–π–ª–∞

pg_walfile_name_offset(lsn) ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞ –∏ —Å–º–µ—â–µ–Ω–∏–µ –≤ –±–∞–π—Ç–∞—Ö
```
–ü—Ä–∏–º–µ—Ä:

```sql
SELECT 
    pg_current_wal_lsn(),
    pg_walfile_name(pg_current_wal_lsn())
```

## üéØ –í–ª–∏—è–Ω–∏–µ –Ω–∞ –¥—Ä—É–≥–∏–µ –±–∞–∑—ã –ø—Ä–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –æ–¥–Ω–æ–π –±–∞–∑—ã

**–í–∞–∂–Ω–æ: —Å–ª–æ—Ç —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ö–û–ù–ö–†–ï–¢–ù–û–ô –ë–ê–ó–ï**, –Ω–æ WAL-—Ñ–∞–π–ª—ã –æ–±—â–∏–µ –¥–ª—è –≤—Å–µ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞.

### –ï—Å–ª–∏ –≤—ã —Ä–µ–ø–ª–∏—Ü–∏—Ä—É–µ—Ç–µ —Ç–æ–ª—å–∫–æ –æ–¥–Ω—É –±–∞–∑—É:
```sql
-- –°–æ–∑–¥–∞–µ–º —Å–ª–æ—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –±–∞–∑—ã
SELECT pg_create_logical_replication_slot('my_slot', 'pgoutput');

-- –≠—Ç–æ—Ç —Å–ª–æ—Ç –±—É–¥–µ—Ç —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å WAL —Ç–æ–ª—å–∫–æ –¥–ª—è –°–í–û–ï–ô –±–∞–∑—ã
-- –ù–æ WAL-—Ñ–∞–π–ª—ã —Ñ–∏–∑–∏—á–µ—Å–∫–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –±–∞–∑ –∫–ª–∞—Å—Ç–µ—Ä–∞
```

### –ß—Ç–æ –ù–ï –ø–µ—Ä–µ–ø–æ–ª–Ω–∏—Ç—Å—è:
- **–î—Ä—É–≥–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö** - –∏—Ö –¥–∞–Ω–Ω—ã–µ –Ω–µ –±—É–¥—É—Ç –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å—Å—è –≤ —Å–ª–æ—Ç–µ
- **–¢–∞–±–ª–∏—Ü—ã –≤ –¥—Ä—É–≥–∏—Ö –±–∞–∑–∞—Ö** - –Ω–µ –±—É–¥—É—Ç —Ä–∞—Å—Ç–∏ –∏–∑-–∑–∞ –≤–∞—à–µ–≥–æ —Å–ª–æ—Ç–∞

### –ß—Ç–æ –ú–û–ñ–ï–¢ –ø–µ—Ä–µ–ø–æ–ª–Ω–∏—Ç—å—Å—è:
- **–î–∏—Å–∫ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ `pg_wal`** - –µ—Å–ª–∏ —Å–ª–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç —á–∏—Ç–∞—Ç—å—Å—è, –æ–Ω –±—É–¥–µ—Ç —É–¥–µ—Ä–∂–∏–≤–∞—Ç—å WAL –¥–ª—è —Å–≤–æ–µ–π –±–∞–∑—ã
- **–û–±—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã –∫–ª–∞—Å—Ç–µ—Ä–∞** - CPU, –ø–∞–º—è—Ç—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ WAL

## ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–ü–µ—Ä–µ–¥ –≤–∫–ª—é—á–µ–Ω–∏–µ–º `wal_level = logical` –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```sql
-- 1. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ—Ç–æ–≤
SHOW max_replication_slots;
-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –≤—Å–µ—Ö –ø–ª–∞–Ω–∏—Ä—É–µ–º—ã—Ö —Å–ª–æ—Ç–æ–≤

-- 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ WAL
SHOW wal_keep_size;
SHOW max_wal_size;

-- 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
SELECT slot_name, database, active, 
       pg_size_pretty(pg_wal_lsn_diff(restart_lsn, '0/0')) as retained_wal
FROM pg_replication_slots
WHERE database = 'your_replicated_db';
```

## üõ°Ô∏è –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–ª–æ—Ç–æ–≤** (—Ä–µ–≥—É–ª—è—Ä–Ω–æ!)
```sql
-- –†–∞–∑–º–µ—Ä WAL, —É–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π –∫–∞–∂–¥—ã–º —Å–ª–æ—Ç–æ–º
SELECT slot_name, database,
       pg_size_pretty(
         pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)
       ) as lag_size
FROM pg_replication_slots;
```

### 2. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–±–æ–µ–≤**
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ **–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏**
- –†–µ–∞–ª–∏–∑—É–π—Ç–µ **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ** –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è —Å–ª–æ—Ç–∞
- –ò–º–µ–π—Ç–µ **–ø—Ä–æ—Ü–µ–¥—É—Ä—É —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è** "–∑–∞–≤–∏—Å—à–∏—Ö" —Å–ª–æ—Ç–æ–≤

### 3. **–ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º**
```bash
# –†–µ–≥—É–ª—è—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞
df -h /path/to/pg_wal

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–ª–æ—Ç–æ–≤
while true; do
  psql -c "SELECT slot_name, active, pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) FROM pg_replication_slots;"
  sleep 300
done
```

## üíé –í—ã–≤–æ–¥

1. **`wal_level = logical` –≤–ª–∏—è–µ—Ç –Ω–∞ –≤–µ—Å—å –∫–ª–∞—Å—Ç–µ—Ä** - WAL-—Ñ–∞–π–ª—ã —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –±–æ–ª—å—à–µ –¥–ª—è –≤—Å–µ—Ö –ë–î
2. **–°–ª–æ—Ç —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Å–≤–æ—é –ë–î** - –¥—Ä—É–≥–∏–µ –±–∞–∑—ã –Ω–µ "–∑–∞–≥—Ä—è–∑–Ω—è—é—Ç" –≤–∞—à —Å–ª–æ—Ç
3. **–ì–ª–∞–≤–Ω—ã–π —Ä–∏—Å–∫ - –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ pg_wal** –µ—Å–ª–∏ —Å–ª–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç —á–∏—Ç–∞—Ç—å—Å—è
4. **–†–µ—à–µ–Ω–∏–µ**: –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ + –±—ã—Å—Ç—Ä–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è

**–í–∞—à–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–∞**, –µ—Å–ª–∏ –≤—ã:
- –ù–∞—Å—Ç—Ä–æ–∏–ª–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏—è —Å–ª–æ—Ç–∞
- –ò–º–µ–µ—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É —É–¥–∞–ª–µ–Ω–∏—è "–∑–∞–≤–∏—Å—à–∏—Ö" —Å–ª–æ—Ç–æ–≤
- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç–µ –º–µ—Å—Ç–æ –≤ pg_wal
- –£–±–µ–¥–∏–ª–∏—Å—å, —á—Ç–æ `max_replication_slots` –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ

–ü—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ –ª–æ–≥–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è –æ–¥–Ω–æ–π –±–∞–∑—ã –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –ë–î —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ!
