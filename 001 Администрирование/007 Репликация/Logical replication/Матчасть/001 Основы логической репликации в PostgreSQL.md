# –°–∏—Å—Ç–µ–º–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ PostgreSQL –¥–ª—è —Ç–æ–Ω–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Flink —á–µ—Ä–µ–∑ Debezium

[–ì–ª–∞–≤–∞ 29. –õ–æ–≥–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è](https://postgrespro.ru/docs/postgresql/current/logical-replication)  
[Chapter 29. Logical Replication](https://www.postgresql.org/docs/current/logical-replication.html)  
[–õ–æ–≥–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è PostgreSQL: –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è](https://timeweb.cloud/tutorials/postgresql/logicheskaya-replikaciya-postgresql)  
> ^ –∑–¥–µ—Å—å –ø–æ–¥—Ä–æ–±–Ω–æ –ø—Ä–æ —Ç–æ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è pg_dump –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Å—Ö–µ–º

[Debezium connector for PostgreSQL](https://debezium.io/documentation/reference/stable/connectors/postgresql.html)   
[Postgres replication lag using debezium connector](https://medium.com/@pawanpg0963/postgres-replication-lag-using-debezium-connector-4ba50e330cd6)   
[Debezium Snapshots Revisited!](https://www.youtube.com/watch?v=Lp0Rg8_nxUs)   
[–û—Ç–ª–∞–¥–∫–∞ –∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º –≤ PostgreSQL Streaming Replication](https://habr.com/ru/companies/oleg-bunin/articles/414111/)   
[Using Stand-by Servers for Postgres Logical Replication](https://www.decodable.co/blog/postgres-logical-replication)  
> ^ Postgres 16 [support logical replication from stand-by servers](https://github.com/AV-ghub/PostgreSQL/blob/main/001%20%D0%90%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/007%20%D0%A0%D0%B5%D0%BF%D0%BB%D0%B8%D0%BA%D0%B0%D1%86%D0%B8%D1%8F/Logical%20replication/%D0%9C%D0%B0%D1%82%D1%87%D0%B0%D1%81%D1%82%D1%8C/003%20Using%20Stand-by%20Servers%20for%20Postgres%20Logical%20Replication.md)

[Logical Replication From Postgres 16 Stand-By Servers‚ÄîDebezium and Failover Slots](https://www.decodable.co/blog/logical-replication-from-postgres-16-stand-by-servers-part-2-of-2)  
[–ì–ª–∞–≤–∞ 48. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏](https://postgrespro.ru/docs/postgresql/current/replication-origins)   


–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±–æ–π—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é Debezium –∏ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –ø—Ä–æ—Ü–µ—Å—Å–æ–º.

### üóÑÔ∏è –û—Å–Ω–æ–≤—ã –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –≤ PostgreSQL

–õ–æ–≥–∏—á–µ—Å–∫–∞—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –º–æ–¥–µ–ª–∏ **¬´–∏–∑–¥–∞—Ç–µ–ª—å-–ø–æ–¥–ø–∏—Å—á–∏–∫¬ª (publish/subscribe)**.

-   **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç**: –ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ **–∏–∑–¥–∞—Ç–µ–ª—è (publisher)** —Å–æ–∑–¥–∞–µ—Ç—Å—è **–ø—É–±–ª–∏–∫–∞—Ü–∏—è (Publication)** ‚Äî –Ω–∞–±–æ—Ä —Ç–∞–±–ª–∏—Ü, –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ—Ç–æ—Ä—ã—Ö –Ω—É–∂–Ω–æ —Ä–µ–ø–ª–∏—Ü–∏—Ä–æ–≤–∞—Ç—å. –ü–æ–¥–ø–∏—Å—á–∏–∫ —Å–æ–∑–¥–∞–µ—Ç **–ø–æ–¥–ø–∏—Å–∫—É (Subscription)** –Ω–∞ —ç—Ç—É –ø—É–±–ª–∏–∫–∞—Ü–∏—é. –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã–µ –∫–æ–ø–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å–Ω–∏–º–æ–∫, –∞ –∑–∞—Ç–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫ –ø–æ–ª—É—á–∞–µ—Ç –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–æ–º –∂–µ –ø–æ—Ä—è–¥–∫–µ, —á—Ç–æ –∏ –Ω–∞ –∏–∑–¥–∞—Ç–µ–ª–µ, —á—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—É—é —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å.
-   **–ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã**: –î–ª—è —Ä–∞–±–æ—Ç—ã –º–µ—Ö–∞–Ω–∏–∑–º–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è **—Å–ª–æ—Ç—ã –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏**. –ö–∞–∂–¥—ã–π —Å–ª–æ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –ø–æ—Ç–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ WAL (Write-Ahead Log). Debezium –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ–∑–¥–∞–µ—Ç –æ–¥–∏–Ω —Å–ª–æ—Ç –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –≤—ã –º–æ–∂–µ—Ç–µ —É–ø—Ä–∞–≤–ª—è—Ç—å —ç—Ç–∏–º, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—è –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä.

### ‚öôÔ∏è –¢–æ–Ω–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å Flink

–í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –Ω–∞–±–æ—Ä–∞ —Ç–∞–±–ª–∏—Ü –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ—Ç. –í–æ—Ç –∫–∞–∫ —ç—Ç–æ–≥–æ –¥–æ–±–∏—Ç—å—Å—è.

#### –ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ PostgreSQL

1.  **–°–æ–∑–¥–∞–π—Ç–µ –ø—É–±–ª–∏–∫–∞—Ü–∏—é –¥–ª—è –Ω—É–∂–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü**
    –í–º–µ—Å—Ç–æ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ `ALL TABLES` —è–≤–Ω–æ —É–∫–∞–∂–∏—Ç–µ –≤ SQL-–∑–∞–ø—Ä–æ—Å–µ –¥–µ—Å—è—Ç–æ–∫-–¥—Ä—É–≥–æ–π –Ω—É–∂–Ω—ã—Ö –≤–∞–º —Ç–∞–±–ª–∏—Ü. –≠—Ç–æ –æ—Å–Ω–æ–≤–∞ —Ç–æ–Ω–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
    ```sql
    CREATE PUBLICATION my_publication FOR TABLE table1, table2, schema1.table3, ...;
    ```
2.  **–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ —Ä–æ—Å—Ç —Å–ª–æ—Ç–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏**
    –ü—Ä–æ–±–ª–µ–º–∞ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è –≤–æ–∑–Ω–∏–∫–∞–µ—Ç, –∫–æ–≥–¥–∞ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä –ø–µ—Ä–µ—Å—Ç–∞–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∏ WAL-–∂—É—Ä–ª—ã –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤ —Å–ª–æ—Ç–µ. –î–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è:
    -   **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –†–µ–≥—É–ª—è—Ä–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ —Å–ª–æ—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—é `pg_replication_slots`.
    ```sql
    SELECT slot_name, 
           pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS replication_lag
    FROM pg_replication_slots;
    ```
    -   **Heartbeat-—Ç–∞–±–ª–∏—Ü–∞**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–µ Debezium –ø–∞—Ä–∞–º–µ—Ç—Ä `heartbeat.interval.ms`. –û–Ω –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–ª—É–∂–µ–±–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤ WAL, –Ω–µ –¥–∞–≤–∞—è —Å–ª–æ—Ç—É "–∑–∞—Å—Ç–∞–∏–≤–∞—Ç—å—Å—è", –¥–∞–∂–µ –µ—Å–ª–∏ –≤ —Ü–µ–ª–µ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –¥–æ–ª–≥–æ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π.

#### –ù–∞ —Å—Ç–æ—Ä–æ–Ω–µ Debezium (–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Flink)

–í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Debezium PostgreSQL Connector —É–∫–∞–∂–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—É—é –≤–∞–º–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—é –∏ –æ—Ç–∫–ª—é—á–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ.

```json
{
  "name": "our-custom-connector",
  "config": {
    "connector.class": "io.debezium.connector.postgresql.PostgresConnector",
    "database.hostname": "...",
    "database.dbname": "...",
    "plugin.name": "pgoutput",
    "publication.name": "my_publication", 
    "publication.autocreate.mode": "filtered", 
    "table.include.list": "public.table1, public.table2, schema1.table3",
    "slot.name": "custom_slot_name", 
    "heartbeat.interval.ms": 10000
  }
}
```

-   **`publication.autocreate.mode`: `filtered`** ‚Äî —É–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é –∏ –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—É—é –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü.
-   **`table.include.list`** ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞. –í—Å–µ–≥–¥–∞ –ø–æ–ª–µ–∑–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –≤—ã–±–æ—Ä–∞ —Ç–∞–±–ª–∏—Ü –∏ –∑–¥–µ—Å—å.

### üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∫–æ–Ω—Ç—Ä–æ–ª—è

-   **–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è PostgreSQL**: `pg_replication_slots`, `pg_stat_replication`, `pg_stat_subscription` ‚Äî –≥–ª–∞–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –∏ –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–∏.
-   **–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏**: `pg_current_wal_lsn()`, `pg_last_wal_receive_lsn()` –ø–æ–º–æ–≥–∞—é—Ç —Ç–æ—á–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å –ª–∞–≥.
-   **Debezium REST API**: –ü–æ–∑–≤–æ–ª—è–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞–±–æ—Ç–æ–π –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –µ–≥–æ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å, —á—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º.

### üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏–∑—É—á–µ–Ω–∏—é –∏ –æ—Å–≤–æ–µ–Ω–∏—é

-   **–ù–∞—á–Ω–∏—Ç–µ —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏**: [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è PostgreSQL](https://www.postgresql.org/docs/current/logical-replication.html) –∏ [Debezium](https://debezium.io/documentation/reference/stable/connectors/postgresql.html) ‚Äî —Å–∞–º—ã–µ –Ω–∞–¥–µ–∂–Ω—ã–µ –∏ –ø–æ–ª–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏.
-   **–ü–æ—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –≤ —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ä–µ–¥–µ**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –º–µ–∂–¥—É –¥–≤—É–º—è –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏ PostgreSQL, –ø—Ä–µ–∂–¥–µ —á–µ–º –≤–Ω–µ–¥—Ä—è—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω. –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–Ω—è—Ç—å –Ω—é–∞–Ω—Å—ã –±–µ–∑ —Ä–∏—Å–∫–∞.
-   **–ò–∑—É—á–∏—Ç–µ –æ–ø—ã—Ç —Å–æ–æ–±—â–µ—Å—Ç–≤–∞**: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –±–ª–æ–≥–∏, —Ç–∞–∫–∏–µ –∫–∞–∫ [—Å—Ç–∞—Ç—å—è –Ω–∞ Habr](https://habr.com/ru/companies/oleg-bunin/articles/414111/), —á–∞—Å—Ç–æ —Å–æ–¥–µ—Ä–∂–∞—Ç –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º.

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ —Ç—Ä–µ–±—É–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞. –ö–ª—é—á –∫ —É—Å–ø–µ—Ö—É ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ **—è–≤–Ω–æ —Å–æ–∑–¥–∞–Ω–Ω–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏**, –µ–µ —É–∫–∞–∑–∞–Ω–∏–µ –≤ **–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Debezium** –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è **—Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞** —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–ª–æ—Ç–æ–≤.
