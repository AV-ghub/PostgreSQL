[Презентация](https://www.youtube.com/watch?v=AsaGNjJtrR4&list=PLaFqU3KCWw6JW80WBHPOe-SMJD2NOjmge&index=13)
[Материалы](https://edu.postgrespro.ru/qpt-13/qpt_11_technics.html)


## Приемы оптимизации
<details><summary><h3>Подходы к оптимизации</h3></summary>
  Цель оптимизации запроса — получить адекватный план выполнения.  
  
  #### Пути оптимизации
  ##### Вмешательство в план выполнения
  Если идти таким путем, то хочется иметь возможность целиком или частично отключить планировщик и самому создать план выполнения.  
  Такая возможность называется ***подсказками (хинтами)*** и в явном виде отсутствует в PostgreSQL.
  ##### Статистика
  Другой подход состоит в том, чтобы добиться корректного расчета кардинальности в каждом узле плана.  
  Для этого статистика должна регулярно (оптимально часто) обновляться.  
  Признаком неактуальной (неточной) статистики будет серьезное несоответствие ожидаемого и реального числа строк в листовых узлах плана.

  Для увеличения точности может потребоваться изменить значение **default_statistics_target** (глобально или для отдельных столбцов таблиц).  
  Иногда может оказаться полезным **индекс по выражению**, ***обладающий собственной статистикой***.  
  В отдельных случаях можно использовать **расширенную статистику**.  
  
  Наличие точной актуальной статистики необходимо, но не достаточно для построения хорошего плана.  
  Планировщик может не суметь сделать правильные выводы из имеющейся статистики; часто ошибки связаны с ***неверным расчетом селективности соединений или агрегаций***.
  ##### Настройка глобальных конфигурационных параметров
  Обычно имеет смысл применять оба способа (статистика и глобальные параметры), смотря по ситуации и сообразуясь со здравым смыслом.

  #### Настройки стоимости
  
  > Ввод-вывод можно (и нужно) указывать на уровне табличных пространств
  > * seq_page_cost = 1.0
  > * random_page_cost = 4.0 <-- для SSD следует уменьшить
  > * effective_io_concurrency = 1

  Имеется большое число настроек, которые позволяют задать стоимости элементарных операций, из которых в итоге складывается стоимость плана запроса.  
  Такие настройки имеет смысл изменять, если запрос, в котором планировщик точно спрогнозировал кардинальности, тем не менее выполняется не самым эффективным образом.

  С вводом-выводом связаны настройки, задающие веса для «условных единиц», в которых выражается стоимость.  
  Это параметры **seq_page_cost** и **random_page_cost**, определяющие стоимость чтения одной страницы при последовательном доступе и при произвольном доступе.  
  Значение seq_page_cost равно единице и его не стоит изменять.  
  Высокое значение параметра random_page_cost отражает реалии HDD-дисков. Для ***SSD-дисков*** (а также в случаях, когда все данные с большой вероятностью ***будут закешированы***), значение этого параметра необходимо значительно уменьшать, например, до 1.1.  
  Параметр **effective_io_concurrency** можно ***увеличить до числа независимых дисков в дисковом массиве***.  
  Фактически этот параметр влияет только на количество страниц, которые будут предварительно считаны в кеш при сканировании по битовой карте.
  
  https://postgrespro.ru/docs/postgresql/13/runtime-config-query

  #### Конфигурация методов планировщика
  Улучшить качество планов, выбираемых планировщиком, можно:
  * скорректировав **константы стоимости** (см. выше)
  * выполнив **ANALYZE** вручную
  * изменив значение параметра конфигурации **default_statistics_target**
  * увеличив объём статистики, собираемой для отдельных столбцов, воспользовавшись командой **ALTER TABLE SET STATISTICS**.

  
</details>
