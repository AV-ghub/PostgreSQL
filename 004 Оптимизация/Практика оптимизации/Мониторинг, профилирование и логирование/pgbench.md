[pgbench](https://postgrespro.ru/docs/postgresql/16/pgbench)    
[pgbench & others: Benechmarking PostGreSQL Server](https://github.com/AbdallahCoptan/PostGreSQL-Bench/blob/master/Pgbench.md)

<details><summary><h5>Инициализация</h5></summary>

Для запускаемого по умолчанию теста типа TPC-B требуется предварительно подготовить определённые таблицы.     
Чтобы создать и наполнить эти таблицы, следует запустить 
```sql
pgbench -i dbname
```
> Чтобы указать, как подключиться к серверу баз данных, вы также можете добавить параметры -h, -p и/или -U    

> pgbench -i создаёт четыре таблицы pgbench_accounts, pgbench_branches, pgbench_history и pgbench_tellers, предварительно уничтожая существующие таблицы с этими именами.    

С «коэффициентом масштаба», по умолчанию равным 1, эти таблицы изначально содержат такое количество строк:
```bash
table                   # of rows
---------------------------------
pgbench_branches        1
pgbench_tellers         10
pgbench_accounts        100000
pgbench_history         0
```
[Скрипт](https://github.com/AV-ghub/PostgreSQL/blob/main/001%20%D0%90%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/010%20%D0%97%D0%B0%D0%B4%D0%B0%D1%87%D0%B8%20%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F/002%20%D0%9F%D0%BE%D0%BB%D0%B5%D0%B7%D0%BD%D1%8B%D0%B5%20%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D1%8B.md#%D1%80%D0%B0%D0%B7%D0%BC%D0%B5%D1%80%D1%8B-%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86-%D1%81-%D0%BA%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE%D0%BC-%D1%81%D1%82%D1%80%D0%BE%D0%BA) [Скрипт 2](https://github.com/AV-ghub/PostgreSQL/blob/main/001%20%D0%90%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5/010%20%D0%97%D0%B0%D0%B4%D0%B0%D1%87%D0%B8%20%D0%B0%D0%B4%D0%BC%D0%B8%D0%BD%D0%B8%D1%81%D1%82%D1%80%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F/002%20%D0%9F%D0%BE%D0%BB%D0%B5%D0%B7%D0%BD%D1%8B%D0%B5%20%D1%81%D0%BA%D1%80%D0%B8%D0%BF%D1%82%D1%8B.md#%D1%80%D0%B0%D0%B7%D0%BC%D0%B5%D1%80%D1%8B-%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86-%D1%81-%D0%BA%D0%BE%D0%BB%D0%B8%D1%87%D0%B5%D1%81%D1%82%D0%B2%D0%BE%D0%BC-%D1%81%D1%82%D1%80%D0%BE%D0%BA-2)

Эти числа можно (и в большинстве случаев даже нужно) увеличить, воспользовавшись параметром -s (коэффициент масштаба).    
При этом также может быть полезен ключ -F (фактор заполнения).

</details>
<details><summary><h5>Использование</h5></summary>

Подготовив требуемую конфигурацию, можно запустить тест производительности командой без -i, то есть:
```sql
pgbench [ параметры ] имя_базы
```
##### Наиболее важные параметры
* -c (число клиентов)
* -t (число транзакций)
* -T (длительность)
* -f (файл со скриптом)

</details>

<details><summary><h5>Параметры инициализации</h5></summary>

##### -i (--initialize) Требуется для вызова режима инициализации.

##### -I этапы_инициализации
 d (Drop, удалить) Удалить все существующие таблицы pgbench.    
 t (create Tables, создать таблицы) Создать таблицы, используемые стандартным сценарием pgbench, а именно: pgbench_accounts, pgbench_branches, pgbench_history и pgbench_tellers.    
 g сгенерировать данные на стороне клиента    
 G сгенерировать данные на стороне сервера   
 v Вызывать VACUUM для стандартных таблиц   
 p Создать первичные ключи в стандартных таблицах   
 f Создать ограничения внешних ключей между стандартными таблицами   
-F (--fillfactor) Создать таблицы pgbench_accounts, pgbench_tellers и pgbench_branches с заданным фактором заполнения. Значение по умолчанию — 100.   
-n (--no-vacuum) Этот параметр выключает этап инициализации v, даже если он был указан в -I   
-q (--quiet) Выводится только одно сообщение о прогрессе в 5 секунд (для параметра g)   
-s (--scale=коэффициент_масштаба) Умножить число генерируемых строк на заданный коэффициент.

--foreign-keys Создать ограничения внешних ключей между стандартными таблицами   
--index-tablespace=табл_пространство_индексов Создать индексы в указанном табличном пространстве, а не в пространстве по умолчанию.   
--partition-method=ИМЯ Создать секционированную таблицу pgbench_accounts, применив метод ИМЯ (это может быть range или hash).   
--partitions=ЧИСЛО Создать секционированную таблицу pgbench_accounts   
--tablespace=табличное_пространство Создать таблицы в указанном табличном пространстве, а не в пространстве по умолчанию.   
--unlogged-tables Создать все таблицы как нежурналируемые, а не как постоянные таблицы.   
  
</details>

<details><summary><h5>Параметры тестирования производительности</h5></summary>


  
</details>

<details><summary><h5>Общие параметры</h5></summary>
</details>

##### Пользовательские скрипты
Программа pgbench поддерживает запуск пользовательских сценариев оценки производительности, позволяя заменять стандартный скрипт транзакции скриптом, считываемым из файла (***с параметром -f***). В этом случае «транзакцией» считается одно выполнение данного скрипта.

Файл скрипта содержит одну или несколько команд SQL, разделённых точкой с запятой. Пустые строки и строки, начинающиеся с --, игнорируются.

##### Полезные советы
Никогда не доверяйте тестам, которые выполняются всего несколько секунд. Воспользуйтесь ***параметром -t и -T*** и установите время выполнения не меньше нескольких минут, чтобы избавиться от шума в средних значениях. В некоторых случаях для получения воспроизводимых результатов тестирование должно продолжаться несколько часов. Чтобы понять, были ли получены воспроизводимые значения, имеет смысл запустить тестирование несколько раз.

Для стандартного сценария по типу TPC-B начальный ***коэффициент масштаба (-s) должен быть не меньше числа клиентов***, с каким вы намерены проводить тестирование (-c); в противном случае вы, по большому счёту, будете замерять время конкурентных изменений. Таблица pgbench_branches содержит всего -s строк, а каждая транзакция хочет изменить одну из них, так что если значение -c превышает -s, это несомненно приведёт к тому, что многие транзакции будут блокироваться другими.

Стандартный сценарий тестирования также довольно сильно зависит от того, сколько времени прошло с момента инициализации таблиц: ***накопление неактуальных строк и «мёртвого» пространства в таблицах влияет на результаты***. Чтобы правильно оценить результаты, необходимо учитывать, сколько всего изменений было произведено и когда выполнялась очистка. ***Если же включена автоочистка, это может быть чревато непредсказуемыми изменениями*** оценок производительности.

Иногда, оценивая производительность одного сервера, полезно запускать несколько экземпляров pgbench параллельно, на отдельных клиентских компьютерах.

























