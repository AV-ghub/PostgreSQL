## Конфигурация памяти
Изначально считаем [необходимый объем оперативки](https://github.com/AV-ghub/PostgreSQL/blob/main/004%20%D0%9E%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F/%D0%9F%D1%80%D0%B0%D0%BA%D1%82%D0%B8%D0%BA%D0%B0%20%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8/%D0%A1%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8/%D0%A7%D0%B0%D1%81%D1%82%D0%BD%D1%8B%D0%B5/%D0%A4%D0%BE%D1%80%D0%BC%D1%83%D0%BB%D0%B0%20%D1%80%D0%B0%D1%81%D1%87%D0%B5%D1%82%D0%B0%20%D0%BE%D1%81%D0%BD%D0%BE%D0%B2%D0%BD%D1%8B%D1%85%20%D0%BA%D0%BE%D0%BD%D1%84%D0%B8%D0%B3%D1%83%D1%80%D0%B0%D1%86%D0%B8%D0%BE%D0%BD%D0%BD%D1%8B%D1%85%20%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D0%BE%D0%B2%20%D0%BF%D0%B0%D0%BC%D1%8F%D1%82%D0%B8.md).   

Отключаем [THP](https://github.com/AV-ghub/PostgreSQL/blob/main/004%20%D0%9E%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F/%D0%9F%D1%80%D0%B0%D0%BA%D1%82%D0%B8%D0%BA%D0%B0%20%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8/%D0%A1%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8/%D0%A7%D0%B0%D1%81%D1%82%D0%BD%D1%8B%D0%B5/THP.md)   

Конфигурируем [swapiness](https://github.com/AV-ghub/PostgreSQL/blob/main/004%20%D0%9E%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F/%D0%9F%D1%80%D0%B0%D0%BA%D1%82%D0%B8%D0%BA%D0%B0%20%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8/%D0%A1%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8/%D0%A7%D0%B0%D1%81%D1%82%D0%BD%D1%8B%D0%B5/Swap.md#swappiness)    
Совсем в 0 не ставим, исходя из техники безопасности, оптимально 1-5-10. На небольших объемах памяти лучше занижать. На SSD дисках также лучше ставить меньше.
Но запас на ООМ killer должен быть.   

Настриаваем [поведение OOM killer](https://github.com/AV-ghub/PostgreSQL/blob/main/004%20%D0%9E%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F/%D0%9F%D1%80%D0%B0%D0%BA%D1%82%D0%B8%D0%BA%D0%B0%20%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8/%D0%A1%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8/%D0%A7%D0%B0%D1%81%D1%82%D0%BD%D1%8B%D0%B5/OOM%20killer.md) для обеспечения техники безопасности в отношении основного процесса кластера.

Настраиваем [Linux HugePages](https://github.com/AV-ghub/PostgreSQL/blob/main/004%20%D0%9E%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F/%D0%9F%D1%80%D0%B0%D0%BA%D1%82%D0%B8%D0%BA%D0%B0%20%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8/%D0%A1%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8/%D0%A7%D0%B0%D1%81%D1%82%D0%BD%D1%8B%D0%B5/Linux%20HugePages.md)

[Пример тюнинга с тестами](https://github.com/AV-ghub/PostgreSQL/blob/main/004%20%D0%9E%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D1%8F/%D0%9F%D1%80%D0%B0%D0%BA%D1%82%D0%B8%D0%BA%D0%B0%20%D0%BE%D0%BF%D1%82%D0%B8%D0%BC%D0%B8%D0%B7%D0%B0%D1%86%D0%B8%D0%B8/%D0%A1%D1%86%D0%B5%D0%BD%D0%B0%D1%80%D0%B8%D0%B8/%D0%A7%D0%B0%D1%81%D1%82%D0%BD%D1%8B%D0%B5/PostgreSQL%20and%20OS%20tuning%20with%20perf%20tests.md)   

## Memory for Database Caching [3](https://github.com/AV-ghub/PostgreSQL/blob/main/998%20Books/List.md).[106]
<details><summary><h4>Memory units in the postgresql.conf file</h5></summary>

  The major component to the shared memory used by the server is a large block allocated for caching blocks read from and written to the database. This is set by a parameter named   **shared_buffers**.  
  
  ### Memory units in the postgresql.conf file [3](https://github.com/AV-ghub/PostgreSQL/blob/main/998%20Books/List.md).[107]
  All of the shared memory settings and the starting client settings for the database are stored in the postgresql.conf file.  
  Use the SHOW command to display the value for this setting.  
  The pg_settings view in the database can be used.  
  ```
  show shared_buffers;
  select name, setting, unit, current_setting(name) from pg_settings where name = 'shared_buffers'
  ```

  ### Increasing UNIX shared memory parameters for larger buffer sizes [3](https://github.com/AV-ghub/PostgreSQL/blob/main/998%20Books/List.md).[108]
  When you use the initdb command to create a new PostgreSQL cluster, the server detects how large of a shared memory block it can allocate by starting at a moderate value and _**decreasing it until the allocation is successful**_.  
  
  The following program will produce reasonable starting values by asking getconf for information about how much memory is in your system. Create a shmsetup.sh file with the following contents:
  ```
  #!/bin/bash
  # simple shmsetup script
  page_size=`getconf PAGE_SIZE`
  phys_pages=`getconf _PHYS_PAGES`
  shmall=`expr $phys_pages / 2`
  shmmax=`expr $shmall \* $page_size`
  echo kernel.shmmax = $shmmax
  echo kernel.shmall = $shmall
  ```
  After changing the permission of the shmsetup.sh file, execute the script as follows:
  ```
  $ chmod +x shmsetup.sh
  $ ./shmsetup.sh
  kernel.shmmax = 2123816960
  kernel.shmall = 518510
  ```

  ### Kernel semaphores
  Another occasional sysctl tweaking requirement for PostgreSQL is to increase the number of system semaphores, an object _**used for process communication**_.

  ### Estimating shared memory allocation
  It's possible to predict how much memory the PostgreSQL server is expected to allocate given the server parameters.  
  _**Very little of this is likely to matter**_ to you because all the other sizes are _**dwarfed by shared_buffers**_ unless your client count is extremely high.  

  ### Inspecting the database cache
  You can look inside the current contents of the PostgreSQL shared_buffers database cache using the **pg_buffercache** module.   
  Its SQL component needs to be installed in each database you want to monitor.   
  ```
  $ createdb pgbench
  $ psql pgbench
  pgbench=# CREATE EXTENSION pg_buffercache;
  ```
  You can confirm that the utility is working as expected by looking at how large your system shared_buffers is, and noting that the count of entries returned by pg_buffercache
matches it:
  ```
  postgres=# select name, setting from pg_settings where name = 'shared_buffers';
      name      | setting 
  ----------------+---------
  shared_buffers | 16384

  postgres=# select count(*) from pg_buffercache;
  count 
  -------
  16384
  ```
  
  ### Database disk layout
  The location of this and other important files on the server is available from the pg_settings view
  ```
  postgres=# show data_directory;
  data_directory        
  -----------------------------
  /var/lib/postgresql/16/main
  ```
  To decipher the structure of what's in the base/ directory, we need the OID of the database and the relation OID
  ```
  postgres=# select datname, oid from pg_database;
  datname  |  oid  
  -----------+-------
  postgres  |     5

  postgres=# select relname, oid, relfilenode from pg_class limit 1;
  relname     |  oid  | relfilenode 
  ----------------+-------+-------------
  pg_buffercache | 24580 |           0
  ```
  




  

</details>
















